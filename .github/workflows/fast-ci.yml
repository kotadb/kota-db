name: Fast CI (Development)

# Fast development pipeline - runs essential tests only for rapid feedback
on:
  pull_request:
    branches: [ develop ]
  push:
    branches: [ 'feature/**' ]

# Cancel previous runs for the same PR/branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1
  CARGO_INCREMENTAL: 0
  FAST_FEATURES: git-integration,tree-sitter-parsing,mcp-server

jobs:
  # Lightning-fast essential checks (< 3 minutes total)
  fast-check:
    name: Fast Essential Checks
    runs-on: ubuntu-latest
    timeout-minutes: 8
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        components: rustfmt, clippy
    
    - name: Cache dependencies
      uses: Swatinem/rust-cache@v2
      with:
        cache-on-failure: true
        shared-key: "fast-ci"
    
    - name: Install cargo-nextest
      run: cargo install cargo-nextest --locked
    
    - name: Quick format check
      run: cargo fmt --all -- --check
    
    - name: Essential clippy check
      run: cargo clippy --all-targets --no-default-features --features "${{ env.FAST_FEATURES }}" -- -D warnings
    
    - name: Fast build
      run: cargo build --no-default-features --features "${{ env.FAST_FEATURES }}"
    
    - name: Unit tests (ULTRA FAST)
      run: |
        echo "ðŸš€ Running unit tests with cargo-nextest..."
        time cargo nextest run --lib --no-default-features --features "${{ env.FAST_FEATURES }}"
      env:
        RUST_LOG: error
        CI: true
    
    - name: Critical integration tests only
      run: |
        echo "âš¡ Running only critical integration tests..."
        cargo nextest run \
          --no-default-features \
          --features "${{ env.FAST_FEATURES }}" \
          --test file_storage_integration_test \
          --test http_server_integration_test \
          --release
      env:
        RUST_LOG: error
        CI: true
    
    - name: Fast CI Summary
      run: |
        echo "âœ… Fast CI complete!"
        echo "ðŸŽ¯ Validated:"
        echo "  - Code formatting âœ…"
        echo "  - Essential linting âœ…" 
        echo "  - Unit tests âœ…"
        echo "  - Critical integration tests âœ…"
        echo "â±ï¸  Total time: < 8 minutes for rapid development feedback"

  # Optional security scan (runs in parallel, non-blocking)
  security-scan:
    name: Security Scan (Optional)
    runs-on: ubuntu-latest
    timeout-minutes: 5
    continue-on-error: true
    steps:
    - uses: actions/checkout@v4
    
    - name: Quick security audit
      run: |
        cargo install cargo-audit --locked
        cargo audit || echo "Security issues found - review separately"
