---
tags:
- file
- kota-db
- ext_py
---
#!/usr/bin/env python3
"""
Comprehensive usage example for KotaDB Python client.

This example demonstrates both traditional and new builder pattern approaches,
showcasing the full capabilities of the Python client library.
"""

import time

from kotadb import (
    ClientValidationError,
    DocumentBuilder,
    KotaDB,
    QueryBuilder,
    UpdateBuilder,
    ValidatedPath,
    ValidatedTitle,
)
from kotadb.exceptions import KotaDBError, NotFoundError


def traditional_approach(db):
    """Demonstrate traditional dictionary-based approach."""
    print("ğŸ“ Traditional Approach (Dictionary-based)")
    print("=" * 50)

    # Insert documents using dictionaries
    docs = [
        {
            "path": "/traditional/python-guide.md",
            "title": "Python Programming Guide",
            "content": "Python is a high-level programming language known for its simplicity and readability. It's widely used in web development, data science, and automation.",
            "tags": ["python", "programming", "guide"],
            "metadata": {"author": "python-expert", "difficulty": "beginner"},
        },
        {
            "path": "/traditional/web-frameworks.md",
            "title": "Python Web Frameworks Comparison",
            "content": "Comparing popular Python web frameworks: Django, Flask, FastAPI. Each has its strengths for different use cases.",
            "tags": ["python", "web", "frameworks", "comparison"],
            "metadata": {"author": "web-dev", "difficulty": "intermediate"},
        },
    ]

    doc_ids = []
    for doc in docs:
        try:
            doc_id = db.insert(doc)
            doc_ids.append(doc_id)
            print(f"âœ… Inserted: {doc['title']} (ID: {doc_id})")
        except KotaDBError as e:
            print(f"âŒ Failed to insert {doc['title']}: {e}")

    return doc_ids


def builder_approach(db):
    """Demonstrate new builder pattern approach with type safety."""
    print("\nğŸ—ï¸  Builder Pattern Approach (Type-safe)")
    print("=" * 50)

    doc_ids = []

    # Document 1: Using builder with validated types
    try:
        doc_id = db.insert_with_builder(
            DocumentBuilder()
            .path(ValidatedPath("/builders/rust-systems.md"))
            .title(ValidatedTitle("Rust Systems Programming"))
            .content(
                "Rust provides memory safety without garbage collection, making it ideal for systems programming. Zero-cost abstractions and fearless concurrency are key features."
            )
            .add_tag("rust")
            .add_tag("systems")
            .add_tag("programming")
            .add_metadata("author", "rust-expert")
            .add_metadata("difficulty", "advanced")
            .add_metadata("estimated_read_time", "20 minutes")
        )
        doc_ids.append(doc_id)
        print(f"âœ… Inserted with builder: Rust Systems Programming (ID: {doc_id})")
    except (KotaDBError, ClientValidationError) as e:
        print(f"âŒ Failed to insert with builder: {e}")

    # Document 2: Using builder with auto-generated ID
    try:
        doc_id = db.insert_with_builder(
            DocumentBuilder()
            .path("/builders/database-design.md")
            .title("Modern Database Design Patterns")
            .content(
                "Exploring modern database design patterns including event sourcing, CQRS, and microservices data patterns."
            )
            .add_tag("database")
            .add_tag("design")
            .add_tag("patterns")
            .add_tag("architecture")
            .add_metadata("author", "db-architect")
            .add_metadata("difficulty", "expert")
            .add_metadata("category", "architecture")
        )
        doc_ids.append(doc_id)
        print(f"âœ… Inserted with builder: Database Design (ID: {doc_id})")
    except (KotaDBError, ClientValidationError) as e:
        print(f"âŒ Failed to insert with builder: {e}")

    return doc_ids


def demonstrate_search_patterns(db):
    """Demonstrate different search approaches."""
    print("\nğŸ” Search Pattern Demonstrations")
    print("=" * 50)

    # Traditional search
    print("\nğŸ“‹ Traditional Search:")
    try:
        results = db.query("python programming", limit=5)
        print(f"Found {results.total_count} results:")
        for doc in results.results:
            print(f"  - {doc.title} (tags: {', '.join(doc.tags)})")
    except KotaDBError as e:
        print(f"âŒ Traditional search failed: {e}")

    # Builder-based search
    print("\nğŸ”§ Builder-based Search:")
    try:
        results = db.query_with_builder(
            QueryBuilder().text("programming language").limit(3).tag_filter("programming")
        )
        print(f"Found {results.total_count} results with builder:")
        for doc in results.results:
            print(f"  - {doc.title} (path: {doc.path})")
    except (KotaDBError, ClientValidationError) as e:
        print(f"âŒ Builder search failed: {e}")

    # Advanced query with multiple filters
    print("\nğŸ¯ Advanced Query with Filters:")
    try:
        results = db.query_with_builder(
            QueryBuilder()
            .text("database design patterns")
            .limit(10)
            .tag_filter("architecture")
            .path_filter("/builders/*")
            .add_filter("difficulty", "expert")
        )
        print(f"Found {results.total_count} advanced results:")
        for doc in results.results:
            difficulty = doc.metadata.get("difficulty", "unknown") if doc.metadata else "unknown"
            print(f"  - {doc.title} (difficulty: {difficulty})")
    except (KotaDBError, ClientValidationError) as e:
        print(f"âŒ Advanced search failed: {e}")

    # Semantic search (if available)
    print("\nğŸ§  Semantic Search:")
    try:
        results = db.semantic_search_with_builder(
            QueryBuilder().text("memory management and performance optimization").limit(5)
        )
        print(f"Found {results.total_count} semantic results:")
        for doc in results.results:
            print(f"  - {doc.title}")
    except Exception as e:
        print(f"â„¹ï¸  Semantic search not available: {e}")

    # Hybrid search (if available)
    print("\nğŸ”„ Hybrid Search:")
    try:
        results = db.hybrid_search_with_builder(
            QueryBuilder()
            .text("programming language features")
            .semantic_weight(0.7)  # 70% semantic, 30% text
            .limit(5)
        )
        print(f"Found {results.total_count} hybrid results:")
        for doc in results.results:
            print(f"  - {doc.title}")
    except Exception as e:
        print(f"â„¹ï¸  Hybrid search not available: {e}")


def demonstrate_update_patterns(db, doc_ids):
    """Demonstrate different update approaches."""
    print("\nâœï¸  Update Pattern Demonstrations")
    print("=" * 50)

    if not doc_ids:
        print("No documents available for update demonstration")
        return

    doc_id = doc_ids[0]

    # Traditional update
    print("\nğŸ“ Traditional Update:")
    try:
        updated_doc = db.update(
            doc_id,
            {
                "content": "Updated content using traditional approach. Added new information about best practices.",
                "tags": ["python", "programming", "guide", "updated"],
            },
        )
        print(f"âœ… Updated traditionally: {updated_doc.title}")
    except KotaDBError as e:
        print(f"âŒ Traditional update failed: {e}")

    # Builder-based update
    print("\nğŸ”§ Builder-based Update:")
    try:
        updated_doc = db.update_with_builder(
            doc_id,
            UpdateBuilder()
            .title("Updated: Python Programming Guide")
            .content(
                "Updated content using builder pattern. This provides type safety and validation."
            )
            .add_tag("builder-updated")
            .add_tag("type-safe")
            .remove_tag("guide")  # Remove old tag
            .add_metadata("last_updated", str(int(time.time())))
            .add_metadata("update_method", "builder_pattern"),
        )
        print(f"âœ… Updated with builder: {updated_doc.title}")
        print(f"   New tags: {updated_doc.tags}")
    except (KotaDBError, ClientValidationError) as e:
        print(f"âŒ Builder update failed: {e}")


def demonstrate_error_handling():
    """Demonstrate proper error handling with validated types."""
    print("\nâš ï¸  Error Handling Demonstrations")
    print("=" * 50)

    # Path validation errors
    print("\nğŸš« Path Validation Errors:")
    dangerous_paths = [
        "../../../etc/passwd",  # Directory traversal
        "/path/with\x00null",  # Null bytes
        "",  # Empty path
        "CON.txt",  # Reserved name (Windows)
        "x" * 5000,  # Too long
    ]

    for path in dangerous_paths:
        try:
            ValidatedPath(path)
            print(f"âŒ Should have failed: {path}")
        except ClientValidationError as e:
            print(f"âœ… Correctly blocked: {path[:50]}... - {e}")

    # Title validation errors
    print("\nğŸ“ Title Validation Errors:")
    bad_titles = [
        "",  # Empty
        "   ",  # Only whitespace
        "x" * 2000,  # Too long
    ]

    for title in bad_titles:
        try:
            ValidatedTitle(title)
            print(f"âŒ Should have failed: {title[:20]}...")
        except ClientValidationError as e:
            print(f"âœ… Correctly blocked title - {e}")

    # Builder validation errors
    print("\nğŸ—ï¸  Builder Validation Errors:")
    try:
        DocumentBuilder().build()  # Missing required fields
        print("âŒ Should have failed: missing required fields")
    except ClientValidationError as e:
        print(f"âœ… Correctly blocked incomplete builder - {e}")

    try:
        QueryBuilder().build()  # Missing query text
        print("âŒ Should have failed: missing query text")
    except ClientValidationError as e:
        print(f"âœ… Correctly blocked incomplete query - {e}")


def main():
    """Run comprehensive demonstration of KotaDB Python client."""
    print("ğŸ¯ KotaDB Python Client - Comprehensive Usage Demo")
    print("=" * 70)
    print("This demo shows both traditional and new builder pattern approaches")
    print()

    # Connect to database
    try:
        db = KotaDB("http://localhost:8080")
        print("âœ… Connected to KotaDB")

        # Check health
        health = db.health()
        print(f"Database status: {health.get('status', 'unknown')}")
        print()

    except Exception as e:
        print(f"âŒ Failed to connect: {e}")
        print("Make sure KotaDB server is running on localhost:8080")
        return

    try:
        # Demonstrate different approaches
        traditional_docs = traditional_approach(db)
        builder_docs = builder_approach(db)

        all_doc_ids = traditional_docs + builder_docs

        # Demonstrate search patterns
        demonstrate_search_patterns(db)

        # Demonstrate update patterns
        demonstrate_update_patterns(db, all_doc_ids)

        # Demonstrate error handling
        demonstrate_error_handling()

        # Show database statistics
        print("\nğŸ“Š Database Statistics")
        print("=" * 50)
        try:
            stats = db.stats()
            print(f"Document count: {stats.get('document_count', 'unknown')}")
            print(f"Total size: {stats.get('total_size_bytes', 'unknown')} bytes")
        except Exception as e:
            print(f"Stats not available: {e}")

        # Clean up test documents
        print("\nğŸ—‘ï¸  Cleaning up test documents...")
        for doc_id in all_doc_ids:
            try:
                db.delete(doc_id)
                print(f"âœ… Deleted: {doc_id}")
            except NotFoundError:
                print(f"âš ï¸  Already deleted: {doc_id}")

        print("\nğŸ‰ Comprehensive demo completed successfully!")
        print("The Python client now provides type safety and builder patterns")
        print("equivalent to the Rust implementation's compile-time guarantees.")

    except KotaDBError as e:
        print(f"âŒ Database error: {e}")
    except Exception as e:
        print(f"âŒ Unexpected error: {e}")
    finally:
        db.close()


if __name__ == "__main__":
    main()
